version: '3.8'

services:
  # 1. 聚合网关 - 唯一的对口暴露者
  gateway:
    image: nginx:alpine
    container_name: cyber-gateway
    ports:
      - "80:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - cyber-backbone
    restart: unless-stopped

  # 2. 前端看板 (仅内部访问)
  frontend:
    image: ghcr.io/arturia169/cyber-home-v2:latest
    container_name: cyber-frontend
    networks:
      - cyber-backbone
    restart: unless-stopped

  # 3. 情报大脑 (仅内部访问)
  backend:
    image: ghcr.io/arturia169/cyber-core-v2:latest
    container_name: cyber-backend
    privileged: true
    user: root
    env_file:
      - .env
    volumes:
      - ./data/backend:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - cyber-backbone
    restart: unless-stopped

  # 4. Cloudflare Tunnel - 提供外部 HTTPS 访问
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cyber-tunnel
    restart: unless-stopped
    network_mode: host
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    command: tunnel --no-autoupdate run --protocol http2

networks:
  cyber-backbone:
    driver: bridge
